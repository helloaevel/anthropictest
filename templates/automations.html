{% extends "base_aevel.html" %}
{% block title %}Automations{% endblock %}
{% block content %}
<div class="page-header">
  <h1>Automations</h1>
  <p class="subtitle">Data pipeline and scheduled runs</p>
</div>

<section class="section">
  <h2 class="section-title">Pipeline</h2>
  <div class="grid grid-2">
    <div class="card">
      <div class="card-title">Full pipeline</div>
      <p style="margin: 0 0 1rem; font-size: 0.9375rem; color: var(--text-secondary);">Ingest → Clean → Analyze → Report → Deliver. Run on demand or via schedule.</p>
      <form id="run-pipeline-form">
        <button type="submit" class="btn btn-primary">Run pipeline</button>
      </form>
      <p id="pipeline-result" style="margin-top: 0.75rem; font-size: 0.8125rem; color: var(--text-tertiary);"></p>
    </div>
    <div class="card">
      <div class="card-title">Status</div>
      <p style="margin: 0; font-size: 0.9375rem; color: var(--text-secondary);">Health check and configuration are validated before each run. Configure data source and delivery in Settings or environment.</p>
    </div>
  </div>
</section>

<section class="section">
  <h2 class="section-title">Steps</h2>
  <div class="card">
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Step</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr><td class="cell-primary">Ingest</td><td>Load raw data from source</td></tr>
          <tr><td class="cell-primary">Clean</td><td>Validate and normalize</td></tr>
          <tr><td class="cell-primary">Analyze</td><td>Compute metrics and aggregates</td></tr>
          <tr><td class="cell-primary">Report</td><td>Generate report payload</td></tr>
          <tr><td class="cell-primary">Deliver</td><td>Send to webhook or artifact</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script>
document.getElementById('run-pipeline-form').addEventListener('submit', function(e) {
  e.preventDefault();
  var el = document.getElementById('pipeline-result');
  el.textContent = 'Running…';
  el.style.color = 'var(--text-tertiary)';
  fetch('/trigger', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'full_pipeline' }) })
    .then(function(r) { return r.json(); })
    .then(function(d) {
      var ok = d.pipeline_exit === 0;
      el.textContent = ok ? 'Completed successfully.' : 'Pipeline finished with errors.';
      el.style.color = ok ? 'var(--success)' : 'var(--danger)';
      if (typeof Aevel !== 'undefined') Aevel.toast(ok ? 'Pipeline completed' : 'Pipeline had errors', ok ? 'success' : 'error');
    })
    .catch(function() {
      el.textContent = 'Request failed.';
      el.style.color = 'var(--danger)';
      if (typeof Aevel !== 'undefined') Aevel.toast('Pipeline request failed', 'error');
    });
});
</script>
{% endblock %}
